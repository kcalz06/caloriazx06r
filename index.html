<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Blog</title>
  <link rel="stylesheet" href="blogstyle.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <h1>Your Blog</h1>
  <a href="#" onclick="showAdminLogin()">Admin Login</a>
  <a href="#" onclick="showNewPostForm()">New Post</a>
</header>

<div class="container">

  <!-- Admin login form (hidden by default) -->
  <div id="admin-login" style="display:none;">
    <h3>Admin Login</h3>
    <input type="email" id="admin-email" placeholder="Email">
    <input type="password" id="admin-pass" placeholder="Password">
    <button onclick="adminLogin()">Login</button>
  </div>

  <!-- New post form (hidden by default) -->
  <div id="new-post-form" style="display:none;">
    <h3>Create New Post</h3>
    <input type="text" id="post-title" placeholder="Title">
    <textarea id="post-content" placeholder="Content"></textarea>
    <button onclick="createPost()">Publish</button>
  </div>

  <!-- Posts container -->
  <div class="posts" id="posts">
    <!-- Posts will be dynamically loaded here -->
  </div>
</div>

<script>
  // Supabase setup
  const SUPABASE_URL = "https://jlipdvlisaljkraswxku.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsaXBkdmxpc2FsamtyYXN3eGt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNzMzNjAsImV4cCI6MjA3OTk0OTM2MH0.KK6bv8aqGJPkURYY6SOB29cclLn9aJiORdArwINGMhI";
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;

  // Show/hide forms
  function showAdminLogin() {
    document.getElementById('admin-login').style.display = 'block';
    document.getElementById('new-post-form').style.display = 'none';
  }

  function showNewPostForm() {
    if (!currentUser) return alert("Login first!");
    document.getElementById('new-post-form').style.display = 'block';
    document.getElementById('admin-login').style.display = 'none';
  }

  // Admin login
  async function adminLogin() {
    const email = document.getElementById('admin-email').value;
    const password = document.getElementById('admin-pass').value;
    const { data, error } = await db.auth.signInWithPassword({ email, password });
    if (error) return alert(error.message);
    currentUser = data.user;
    alert("Logged in!");
    showNewPostForm();
  }

  // Create a new post
  async function createPost() {
    const title = document.getElementById('post-title').value;
    const content = document.getElementById('post-content').value;
    if (!title || !content) return alert("Fill in both fields!");

    await db.from("posts").insert({ title, content });
    document.getElementById('post-title').value = '';
    document.getElementById('post-content').value = '';
    document.getElementById('new-post-form').style.display = 'none';
    loadPosts();
  }

  // Load all posts
  async function loadPosts() {
    const { data: posts } = await db.from('posts').select('*').order('created_at', { ascending: false });
    const container = document.getElementById('posts');
    container.innerHTML = '';

    for (const post of posts) {
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      postDiv.id = `post-${post.id}`;
      postDiv.innerHTML = `
        <div class="post-meta">Posted â€¢ ${new Date(post.created_at).toLocaleString()}</div>
        <div class="post-title">${post.title}</div>
        <div class="post-body">${post.content}</div>
        <div class="controls">
          <button onclick="likePost('${post.id}')">â™¡ Like</button>
          <span id="like-count-${post.id}"></span>
          <button onclick="toggleCommentBox('${post.id}')">ðŸ’¬ Comment</button>
        </div>
        <div class="comment-box" id="comment-box-${post.id}" style="display:none;">
          <input id="cname-${post.id}" placeholder="Name">
          <textarea id="ctext-${post.id}" placeholder="Comment"></textarea>
          <button onclick="addComment('${post.id}')">Post</button>
        </div>
        <div class="comments-list" id="comments-${post.id}"></div>
      `;
      container.appendChild(postDiv);
      loadLikes(post.id);
      loadComments(post.id);
    }
  }

  function toggleCommentBox(postId) {
    const box = document.getElementById(`comment-box-${postId}`);
    box.style.display = box.style.display === 'none' ? 'block' : 'none';
  }

  // Likes
  async function likePost(postId) {
    const userIp = await fetch("https://api64.ipify.org?format=json").then(r => r.json()).then(r => r.ip);
    await db.from("likes").insert({ post_id: postId, user_ip: userIp });
    loadLikes(postId);
  }

  async function loadLikes(postId) {
    const { count } = await db.from("likes").select("*", { count: "exact", head: true }).eq("post_id", postId);
    document.getElementById(`like-count-${postId}`).textContent = `${count} likes`;
  }

  // Comments
  async function addComment(postId) {
    const name = document.getElementById(`cname-${postId}`).value || 'Anonymous';
    const comment = document.getElementById(`ctext-${postId}`).value;
    if (!comment) return alert("Comment cannot be empty");

    await db.from("comments").insert({ post_id: postId, name, comment });
    document.getElementById(`cname-${postId}`).value = '';
    document.getElementById(`ctext-${postId}`).value = '';
    loadComments(postId);
  }

  async function loadComments(postId) {
    const { data } = await db.from("comments").select("*").eq("post_id", postId).order("created_at", { ascending: true });
    const container = document.getElementById(`comments-${postId}`);
    container.innerHTML = data.map(c => `<p><strong>${c.name}</strong>: ${c.comment}</p>`).join('');
  }

  // Initial load
  loadPosts();
</script>

</body>
</html>
