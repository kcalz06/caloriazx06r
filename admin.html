<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - My Vlog</title>
  <link rel="stylesheet" href="admin.css">

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Quill CSS & JS -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
</head>
<body>
<header>
  <h1>Admin Dashboard</h1>
  <a href="index.html">Go to Blog</a>
</header>

<!-- Admin login -->
<div id="admin-login">
  <input type="email" id="admin-email" placeholder="Email">
  <input type="password" id="admin-pass" placeholder="Password">
  <button id="login-btn">Login</button>
</div>

<!-- New Post Form -->
<div id="new-post-form" style="display:none; margin-top: 1rem;">
  <input type="text" id="post-title" placeholder="Post Title">

  <!-- Quill Editor -->
  <div id="editor" style="height: 250px; background: #fff;"></div>

  <button id="publish-btn">Publish</button>
</div>

<script>
// ----------------------
// Supabase setup
// ----------------------
const SUPABASE_URL = "https://jlipdvlisaljkraswxku.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsaXBkdmxpc2FsamtyYXN3eGt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNzMzNjAsImV4cCI6MjA3OTk0OTM2MH0.KK6bv8aqGJPkURYY6SOB29cclLn9aJiORdArwINGMhI"; 
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;

// ----------------------
// Initialize Quill
// ----------------------
const quill = new Quill('#editor', {
  theme: 'snow',
  placeholder: 'Write your post here...',
  modules: {
    toolbar: [
      [{ header: [1, 2, 3, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      ['link', 'image'],
      [{ list: 'ordered' }, { list: 'bullet' }],
      [{ align: [] }],
      ['clean']
    ]
  }
});

// ----------------------
// ADMIN LOGIN
// ----------------------
async function adminLogin() {
  const email = document.getElementById('admin-email')?.value.trim();
  const password = document.getElementById('admin-pass')?.value;

  if (!email || !password) return alert("Email and password required");

  try {
    const { data, error } = await db.auth.signInWithPassword({ email, password });
    if (error) throw error;

    currentUser = data.user;
    alert("Logged in as admin!");

    document.getElementById('admin-login').style.display = 'none';
    document.getElementById('new-post-form').style.display = 'block';

    loadPosts();
  } catch (err) {
    alert(err.message);
    console.error(err);
  }
}

// ----------------------
// CREATE NEW POST
// ----------------------
async function newPost() {
  if (!currentUser) return alert("Admin login required!");

  const title = document.getElementById('post-title').value.trim();
  const content = quill.root.innerHTML.trim();

  if (!title || !content) return alert("Title and content are required");

  try {
    await db.from("posts").insert({ title, content });
    document.getElementById('post-title').value = '';
    quill.setContents([]);
    loadPosts();
  } catch (err) {
    console.error(err);
    alert("Failed to publish post");
  }
}

// ----------------------
// LOAD POSTS
// ----------------------
async function loadPosts() {
  try {
    const { data: posts } = await db
      .from("posts")
      .select("*")
      .order("created_at", { ascending: false });

    const container = document.getElementById("posts");
    if (!container) return;
    container.innerHTML = '';

    posts.forEach(post => {
      const wrapper = document.createElement("div");
      wrapper.className = "post";
      wrapper.id = `post-${post.id}`;
      wrapper.innerHTML = `
        <div class="post-meta">${new Date(post.created_at).toLocaleString()}</div>
        <div class="post-title">${post.title}</div>
        <div class="post-body">${post.content}</div>
      `;
      container.appendChild(wrapper);
    });
  } catch (err) {
    console.error(err);
  }
}

// ----------------------
// GLOBAL FUNCTIONS
// ----------------------
window.adminLogin = adminLogin;
window.newPost = newPost;
window.loadPosts = loadPosts;

// ----------------------
// BUTTON EVENTS
// ----------------------
document.getElementById('login-btn').addEventListener('click', adminLogin);
document.getElementById('publish-btn').addEventListener('click', newPost);

// Load posts on page (optional)
document.addEventListener("DOMContentLoaded", loadPosts);
</script>
</body>
</html>
